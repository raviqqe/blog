# スケーラブルな開発のための新しいプログラミング言語：Pen

## TL;DR

- Pen という名前の新しいプログラミング言語を開発中
- スケーラブルなソフトウェア開発のための言語
- いいね、よろしくおねがいします！
  - [GitHub レポジトリ](https://github.com/pen-lang/pen)

### 導入

Pen 言語という新しいプログラミング言語を GitHub でオープンソースで開発しています。アプリケーションプログラミングに焦点を置いていて、誰でも簡単に学習し、良いプログラムが書ける言語を目指しています。パラダイムとしては、関数型プログラミング寄りで、純粋ではありませんが独自の[副作用](<https://ja.wikipedia.org/wiki/%E5%89%AF%E4%BD%9C%E7%94%A8_(%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0)#:~:text=%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%8A%E3%81%84%E3%81%A6%E3%80%81%E5%BC%8F%E3%81%AE%E8%A9%95%E4%BE%A1,%E3%81%95%E3%81%9B%E3%82%8B%E4%BD%9C%E7%94%A8%E3%82%92%E5%89%AF%E4%BD%9C%E7%94%A8%E3%81%A8%E3%81%84%E3%81%86%E3%80%82>)を管理する仕組みがあります。

- [GitHub レポジトリ](https://github.com/pen-lang/pen)
- [ドキュメンテーション](https://pen-lang.org)
- [コード例](https://github.com/pen-lang/pen/tree/main/examples)

Hello, world の例:

```pen
import System'Context { Context }
import System'File

sayHello = \(ctx Context) none | error {
  File'Write(ctx, File'StdOut(), "Hello, world!\n")?

  none
}

main = \(ctx Context) number {
  e = sayHello(ctx)

  if e = e as none {
    0
  } else if error {
    1
  }
}
```

### 目的

Pen 言語の開発目的は、ソフトウェア開発をスケーラブルにすること、つまり、長期間、また、多人数によるソフトウェア開発を効率化することです。そのために、Pen 言語はソフトウェアの性質の中でも保守性と移植性を重視した言語になっています。

- 保守性
  - **最小設計の言語機能**が、新しい開発者の学習コストを下げ、また、開発者間のコミュニケーションを効率化します。
  - 関数における副作用の使用を制限することで、**テストの容易性・信頼性**を向上させます。
  - アプリケーションと実装の詳細のコードを分けることで、それぞれのロジックの**変更を容易**にします。
- 移植性
  - Pen 言語で書かれたソフトウェアは異なるプラットフォームに容易に移植できます。

### 機能

#### 小さな言語設計

これらの目的を達成するために、Pen 言語は構文の表現力や実用性を保ちつつ、非常にミニマルで制限が強い言語として設計されています。既存のミニマルな言語設計がなされた例として[Go 言語](https://go.dev/)がありますが、それと比較してもとても小さいことが分かると思います。

##### 型・構文

[型システム](https://pen-lang.org/references/language/types.html)は、静的型付けでサブタイピングがあります。しかし、言語の複雑さを抑えるためジェネリクスはありません。組み込みの型には、数値型、文字列型、リスト型、None 型、レコード型、ユニオン型等があります。将来的に、配列型やマップ型の拡張を考えています。システムプログラミングではなく、アプリケーションプログラミングを主要な用途に考えているため、ビット数固定の整数型等は実装されていません。

[構文](https://pen-lang.org/references/language/syntax.html)には値リテラル、演算子、If 式等があります。基本的に式指向で関数定義を含め、ほとんどが式として表現できます。ビルトインのいくつかの型（ユニオン、リスト等）にはそれらの値に対する独自の構文があります。

四則演算の例:

```pen
f = \() number {
  1 + 2 - 3 * 4 / 5
}
```

型スイッチ（ダウンキャスト）の例:

```pen
f = \(x number | none) number {
  if x = x as number {
    x
  } else if none {
    0
  }
}
```

#### システム注入

[システム注入](https://pen-lang.org/advanced-features/system-injection.html)は、Pen 言語独自の関数の副作用を管理する仕組みです。主に以下の２点の機能から成ります。

- 関数内における副作用の制限
  - 関数の副作用は常にその引数から注入されます。これによりある関数が意図せずに非純粋になることを防ぎます。
  - 慣習的にこれらの副作用を表現する値の型はコンテキスト型と呼ばれ、関数の先頭の引数として渡されます。
- システムパッケージ
  - システム依存なコードはシステムパッケージという特別なパッケージによって提供されます。
  - システムパッケージが提供するコンテキスト型を、アプリケーションのメイン関数に渡すことによって、初めてアプリケーションは副作用を起こすことができます。

システム注入によって開発者は、ソフトウェアのテスト容易性・信頼性、移植性の向上といった恩恵を受けられます。

ファイル書き込みの例:

```pen
import System'Context { Context }
import System'File
import System'File'OpenOptions

writeFile = \(ctx Context) none | error {
  f = File'OpenWithOptions(
    ctx,
    "./foo.txt",
    OpenOptions{...OpenOptions'Default(), Write: true},
  )?

  File'Write(ctx, f, "foo")?

  none
}

main = \(ctx Context) number {
  if _ = writeFile(ctx) as none {
    0
  } else {
    1
  }
}
```

#### 決定的なテストフレームワーク

Pen 言語には組み込みの[テストフレームワーク](https://pen-lang.org/guides/testing.html)があります。また、関数の副作用が制限されているため、全てのユニットテストが決定的です。これにより、コードの変更によって、テストが確率的に失敗したり、遅くなることがありません。

### 開発状況

最新版は v0.3.4 で主要な言語機能は既に実装されています。現在は、非同期ランタイムの開発に注力しています。

#### 既に実装されている機能

- 主要な言語構文
- 組み込み型（数値、文字列、リスト等）
- 参照カウント GC
- モジュール・パッケージシステム
- [テストフレームワーク](https://pen-lang.org/guides/testing.html)
- 標準パッケージ (`Os`, `Core`)
- [クロスコンパイル](https://pen-lang.org/advanced-features/cross-compile.html)
- [外部関数インターフェース](https://pen-lang.org/advanced-features/ffi.html)
- [WebAssembly](https://webassembly.org/)/[WASI](https://wasi.dev/)ターゲット

#### 今後実装予定の機能

##### 非同期ランタイム

一般に、プログラムが時間を消費する場合は大きく分けて２つ、CPU が計算をする、または、しない場合があります。この CPU が計算をしない場合の処理を別のスレッド等で非同期に処理することによって、プログラム全体の処理を効率化することができます。このような機能は主要な言語（JavaScript、Go、Rust 等）で既に実装され、よく使われています。

Pen 言語では同等の機能を実現するために、コンパイラ内で[継続渡しスタイル](https://ja.wikipedia.org/wiki/%E7%B6%99%E7%B6%9A%E6%B8%A1%E3%81%97%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%AB)という関数の内部表現を使っています。そして、これらの関数を状態マシンとしてスレッドプールで実行することで非同期ランタイムを実装します。現在、コンパイラ側の機能は既に実装されており、[ランタイムライブラリ側を実装中](https://github.com/pen-lang/pen/pull/544)です。

##### 他言語との相互運用性の向上

Pen 言語には既に OS とのインタフェースを担う標準パッケージが存在しています。しかし、その API はとてもプリミティブでシステムコールに近いものです。そのため、その上に HTTP フレームワーク等を実装するのには非常に時間がかかります。

この労力を緩和するために、他言語（特に Rust）の既存ライブラリの内、システム API を必要とするものを再利用できる仕組みを考えています。具体的には、前述したシステムパッケージを一つのアプリケーション内で複数使えるようにする予定です。これにより、例えば、OS パッケージ内のファイルシステム API と HTTP フレームワークパッケージ内の API が同時に使えます。ただし、これら複数のシステムパッケージが同じコンパイルターゲットをサポートしている必要があります。

##### その他

その他に以下の機能を実装予定です。

- 言語構文の細かな調整
- 標準パッケージの API 拡張
- 並列・並行計算プリミティブの設計・実装

### おまけ

- 開発に参加したいという方は是非ご連絡ください!
  - [GitHub](https://github.com/pen-lang)
  - [Twitter](https://twitter.com/pen_language)
- [プログラミング言語処理系が好きなひとの集まり](https://prog-lang-sys-ja-slack.github.io/wiki/)という Slack で開発を行っています。興味のある方は是非ご参加ください！
